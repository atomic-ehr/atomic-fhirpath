# FHIRPath ANTLR Parser

This directory contains ANTLR-generated TypeScript parser and visitor for FHIRPath expressions.

## Generated Files

The following files were generated by ANTLR from the `fhirpath.g4` grammar:

### Core Parser Files
- `fhirpathLexer.ts` - Lexical analyzer for tokenizing FHIRPath expressions
- `fhirpathParser.ts` - Parser that builds parse trees from tokens
- `fhirpathVisitor.ts` - Visitor interface for traversing parse trees
- `fhirpathListener.ts` - Listener interface for parse tree events

### Supporting Files
- `fhirpath.tokens` - Token definitions
- `fhirpathLexer.tokens` - Lexer token mappings
- `fhirpath.interp` - Parser interpreter data
- `fhirpathLexer.interp` - Lexer interpreter data

## Custom Files

### Visitor Implementations
- `FhirpathVisitor.ts` - Custom visitor interface definitions
- `FhirpathBaseVisitor.ts` - Base visitor implementation with default behavior
- `FhirpathParserDemo.ts` - Example visitor implementation and demonstration

### Configuration
- `package.json` - Package configuration and dependencies
- `tsconfig.json` - TypeScript configuration
- `index.ts` - Main module exports

## Usage

### Basic Parsing

```typescript
import { CharStream, CommonTokenStream } from 'antlr4';
import { fhirpathLexer, fhirpathParser, parseFhirpathExpression } from './index.js';

// Simple parsing with the utility function
const result = parseFhirpathExpression("Patient.name.given");
console.log(result);

// Manual parsing for more control
const input = new CharStream("Patient.age > 18");
const lexer = new fhirpathLexer(input);
const tokens = new CommonTokenStream(lexer);
const parser = new fhirpathParser(tokens);
const tree = parser.entireExpression();
```

### Custom Visitor

```typescript
import { FhirpathBaseVisitor } from './index.js';

class MyFhirpathVisitor extends FhirpathBaseVisitor<any> {
    visitStringLiteral(ctx: any): string {
        return `String: ${ctx.getText()}`;
    }
    
    visitNumberLiteral(ctx: any): number {
        return parseFloat(ctx.getText());
    }
    
    // Override other visit methods as needed...
}

// Use your custom visitor
const visitor = new MyFhirpathVisitor();
const result = visitor.visit(tree);
```

## Installation

Install dependencies:

```bash
bun install
```

## Scripts

- `bun run generate` - Regenerate parser files from grammar
- `bun run build` - Build and minify TypeScript files with Bun (fast!)
- `bun run build-tsc` - Alternative build with TypeScript compiler
- `bun run demo` - Run the demonstration (from built files)
- `bun run demo-errors-direct` - Run error handling demo directly from TypeScript
- `bun run test-parsing-direct` - Quick test directly from TypeScript (no build needed)

## Grammar Features Supported

The parser supports the complete FHIRPath grammar including:

### Expressions
- Term expressions
- Invocation expressions (dot notation)
- Indexer expressions (bracket notation)
- Polarity expressions (unary + and -)
- Arithmetic expressions (+, -, *, /, div, mod)
- Type expressions (is, as)
- Union expressions (|)
- Comparison expressions (<, <=, >, >=)
- Equality expressions (=, ~, !=, !~)
- Membership expressions (in, contains)
- Logical expressions (and, or, xor, implies)

### Literals
- Null literals (`{}`)
- Boolean literals (`true`, `false`)
- String literals (`'text'`)
- Number literals (`123`, `123.45`)
- Long number literals (`123L`)
- Date literals (`@2023-01-01`)
- DateTime literals (`@2023-01-01T10:30:00`)
- Time literals (`@T10:30:00`)
- Quantity literals (`5 'mg'`, `10 days`)

### Invocations
- Member access (`Patient.name`)
- Function calls (`count()`, `where(condition)`)
- Built-in variables (`$this`, `$index`, `$total`)
- External constants (`%variable`)

### Advanced Features
- Parenthesized expressions
- Qualified identifiers (`System.ValueSet`)
- Date/time precision units
- UCUM unit strings

## Example Expressions

The parser can handle complex FHIRPath expressions like:

```
Patient.name.where(use = 'official').given.first()
Observation.component.where(code.coding.code = 'systolic').value as Quantity
Bundle.entry.resource.where($this is Patient).name.family
Patient.telecom.where(system = 'phone' and use = 'home').value
```

## Regenerating Parser

If you modify the grammar file (`fhirpath.g4`), regenerate the parser files:

```bash
bun run generate
```

This will use ANTLR to generate fresh TypeScript files in the `generated/` directory.

## Dependencies

- `antlr4` - ANTLR runtime for TypeScript/JavaScript
- `typescript` - TypeScript compiler (optional, Bun can run TS directly)
- **Bun** - Fast JavaScript runtime, bundler, and package manager
- ANTLR 4.13.2+ - Parser generator (for regenerating files)

## Why Bun?

This project uses **Bun** for improved performance:
- âš¡ **Direct TypeScript execution** - No compilation step needed during development
- ðŸš€ **Fast builds** - Bun's bundler is significantly faster than traditional tools
- ðŸ“¦ **All-in-one** - Runtime, bundler, and package manager in one tool
- ðŸ”¥ **Hot reloading** - Instant feedback during development 